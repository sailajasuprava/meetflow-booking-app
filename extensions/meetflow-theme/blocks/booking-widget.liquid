<div class="meetflow-booking-widget">
  <div class="mf-widget-inner">

    <!-- Left -->
    <div class="mf-widget-image">
      <img
        src="{{ 'calendar2.jpg' | asset_url }}"
        alt="MeetFlow Appointment"
        width="420"
        height="560"
        loading="lazy"
/>
    </div>

    <!-- Right -->
    <div class="mf-widget-content">
      <h3 class="mf-widget-title">Book an appointment</h3>
      <button class="meetflow-btn" id="meetflow-open-modal">
        Schedule appointment
      </button>
    </div>

  </div>
</div>

<div id="mf-toaster" class="mf-toast" style="display: none;">
  <span class="mf-toast-icon">âœ…</span>
  <span id="mf-toast-message"></span>
</div>

<div id="meetflow-modal" class="mf-modal-overlay" style="display: none;">
  <div class="mf-modal-content">
    <div class="mf-modal-header">
      <div class="mf-header-title">
        <h4><span>ðŸ“… </span>Appointment Test</h4>
      </div>
      <button id="meetflow-close-modal" class="mf-close-btn">&times;</button>
    </div>

    <div class="mf-modal-body">
    {% comment %}
       <div class="mf-duration">ðŸ•’ 2 hours, 30 minutes</div> 
      {% endcomment %}

    <div class="mf-duration" id="mf-duration">ðŸ•’</div>

      <div class="mf-grid">
        <div class="mf-calendar-side">
            <input type="hidden" id="mf-date-picker">
  
            <div class="mf-custom-calendar">
              <div class="mf-calendar-header">
                <div id="mf-current-month" class="mf-month-display">December 2025</div>
                <div class="mf-calendar-nav">
                  <button type="button" id="mf-prev-month">&lt;</button>
                  <button type="button" id="mf-next-month">&gt;</button>
                </div>
              </div>
              <div class="mf-calendar-weekdays">
                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
              </div>
              <div id="mf-calendar-days" class="mf-calendar-grid">
                </div>
            </div>
      </div>

        <div class="mf-time-side">
          <p class="mf-day-label" id="mf-selected-day-label">Select a date</p>
          <div class="mf-time-slots" id="mf-slots-container">

          </div>
        </div>
      </div>
    </div>

    <div class="mf-modal-footer">
      <button id="mf-book-now" class="mf-book-btn" disabled>Book now</button>
    </div>
  </div>
</div>

<style>

/* === MeetFlow Widget Layout Fix === */
.meetflow-booking-widget {
  width: 100%;
  padding: 32px 0;
}

/* Force equal halves */
.mf-widget-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 24px;

  display: flex;
  align-items: center;
  gap: 40px;
}

/* Left = 50% */
.mf-widget-image {
  flex: 1;
  display: flex;
  justify-content: center;
}

.mf-widget-image img {
  width: 100%;
  max-width: 420px;
  height: auto;
  border-radius: 16px;
}

/* Right = 50% */
.mf-widget-content {
  flex: 1;
}

.mf-widget-title {
  font-size: 2.25rem;
  font-weight: 700;
  margin-bottom: 20px;
  color: #111827;
}

/* Fix button being too large */
.meetflow-btn {
  width: auto;
  padding: 14px 28px;
  font-size: 16px;
  border-radius: 10px;
}

/* Mobile */
@media (max-width: 768px) {
  .mf-widget-inner {
    flex-direction: column;
    text-align: center;
  }

  .mf-widget-image img {
    max-width: 280px;
  }

  .meetflow-btn {
    width: 100%;
  }
}


  /* Existing Styles */
  .meetflow-btn { width: 100%; padding: 14px 20px; font-size: 16px; font-weight: 600; color: #fff; background: #111827; border: none; border-radius: 10px; cursor: pointer; }

  /* Toast Styles */
  .mf-toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #ffffff;
    color: #111827;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    border-left: 4px solid #10b981;
    z-index: 2147483647;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Modal Styles */
  .mf-modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 999999 !important; }
  body.mf-modal-open { overflow: hidden !important; }
  .mf-modal-content { background: #fff; width: 100%; max-width: 850px; max-height: 90vh; border-radius: 12px; overflow-y: auto; position: relative; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
  .mf-modal-header { padding: 16px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .mf-header-title { display: flex; align-items: center; gap: 10px; color: #6366F1; }
  .mf-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; }
  .mf-modal-body { padding: 24px; }
  .mf-duration { margin-bottom: 20px; font-size: 14px; color: #000; }
  .mf-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
  .mf-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
  .mf-day-label { color: #6366F1; font-weight: 600;  font-size: 1.125rem;  text-align: center; }
  .mf-time-slots { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; }
  .mf-slot { padding: 12px; border: 1px solid #6366F1; background: #fff; color: #000; border-radius: 12px; cursor: pointer; text-align: center; transition: 0.2s; }
  .mf-slot.selected { background: #6366F1; color: #fff; }
  .mf-modal-footer { padding: 16px 24px; border-top: 1px solid #eee; display: flex; justify-content: center; }
  .mf-book-btn { background: #6366F1; color: #fff; padding: 12px 60px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
  .mf-book-btn:disabled { background: #A5B4FC; cursor: not-allowed; }
/* Custom Calendar Styles */
  .mf-custom-calendar {
    background: #fff;
    border-radius: 12px;
    padding: 10px;
    user-select: none;
  }
  .mf-calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 0 5px;
  }
  .mf-month-display {
    font-weight: 700;
    font-size: 1.1rem;
    color: #6366F1; /* Matching the blue in your screenshot */
  }
  .mf-calendar-nav button {
    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: #4b5563;
    padding: 5px 10px;
  }
  .mf-calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 500;
    color: #6b7280;
    font-size: 0.85rem;
    margin-bottom: 10px;
  }
  .mf-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .mf-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.9rem;
    border-radius: 50%;
    transition: 0.2s;
    color: #374151;
  }
  .mf-day:hover:not(.empty):not(.disabled) {
    background: #eff6ff;
  }
  .mf-day.selected {
    background: #6366F1 !important;
    color: #fff !important;
  }
  .mf-day.disabled {
    color: #d1d5db;
    cursor: not-allowed;
  }
  .mf-day.empty {
    cursor: default;
  }
  @media (max-width: 640px) { .mf-grid { grid-template-columns: 1fr; } }
</style>

<script>

window.MEETFLOW_SHOP = "{{ shop.permanent_domain }}";
console.log("MEETFLOW_SHOP set to:", window.MEETFLOW_SHOP); // Debug

async function fetchBookingConfig() {
  const shop = window.MEETFLOW_SHOP || Shopify?.shop;
  
  console.log("Using shop:", shop);
  
  const response = await fetch(
    `https://meetflow-booking-app-roi7.vercel.app/api/public/booking-config?shop=${shop}`
  );
  
  console.log("Response status:", response.status);
  return await response.json();
}

function formatTime(totalMinutes) {
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  const suffix = h >= 12 ? "PM" : "AM";
  const hour12 = ((h + 11) % 12) + 1;
  const mm = m.toString().padStart(2, "0");
  return `${hour12}:${mm} ${suffix}`;
}

function generateSlots(config, container, updateButtonState) {
  const durationMinutesTotal =
    parseInt(config.durationHours, 10) * 60 +
    parseInt(config.durationMinutes, 10);

  const increment = config.incrementUnit === 'hours'
    ? parseInt(config.incrementValue, 10) * 60
    : parseInt(config.incrementValue, 10);

  container.innerHTML = '';

  let startMinutes = 9 * 60;
  const endMinutes = 18 * 60;

  while (startMinutes + durationMinutesTotal <= endMinutes) {
    const end = startMinutes + durationMinutesTotal;
    const label = `${formatTime(startMinutes)} - ${formatTime(end)}`;

    const btn = document.createElement('button');
    btn.className = 'mf-slot';
    btn.dataset.timeRange = label;
    btn.textContent = label;

    btn.addEventListener('click', function () {
      document.querySelectorAll('.mf-slot').forEach(s => s.classList.remove('selected'));
      this.classList.add('selected');
      window.selectedTimeRange = this.getAttribute('data-time-range');
      updateButtonState();
    });

    container.appendChild(btn);
    startMinutes += increment;
  }
}


document.addEventListener('DOMContentLoaded', async function () {
  const modal = document.getElementById('meetflow-modal');
  const toaster = document.getElementById('mf-toaster');
  const toastMsg = document.getElementById('mf-toast-message');
  const openBtn = document.getElementById('meetflow-open-modal');
  const closeBtn = document.getElementById('meetflow-close-modal');
  const bookBtn = document.getElementById('mf-book-now');
  const datePicker = document.getElementById('mf-date-picker');
  const slotsContainer = document.getElementById('mf-slots-container');
  const durationEl = document.getElementById('mf-duration');
  // New Calender UI logic...
  const calendarDaysContainer = document.getElementById('mf-calendar-days');
  const monthDisplay = document.getElementById('mf-current-month');
  const prevBtn = document.getElementById('mf-prev-month');
  const nextBtn = document.getElementById('mf-next-month');

  window.selectedDate = null;
  window.selectedTimeRange = null;
  window.config = null;

  const originalParent = modal.parentNode;
  const originalNextSibling = modal.nextSibling;
  const toasterOriginalParent = toaster.parentNode;
  const toasterNextSibling = toaster.nextSibling;

  // New Calender UI logic...
  let currentViewDate = new Date();
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  function renderCalendar() {
    calendarDaysContainer.innerHTML = '';
    const year = currentViewDate.getFullYear();
    const month = currentViewDate.getMonth();

    // Set Header
    const monthName = new Intl.DateTimeFormat('en-US', { month: 'long' }).format(currentViewDate);
    monthDisplay.textContent = `${monthName} ${year}`;

    const firstDayIndex = new Date(year, month, 1).getDay();
    const lastDay = new Date(year, month + 1, 0).getDate();

    // Add Empty Slots for previous month days
    for (let i = 0; i < firstDayIndex; i++) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'mf-day empty';
      calendarDaysContainer.appendChild(emptyDiv);
    }

    // Add Actual Days
    for (let i = 1; i <= lastDay; i++) {
      const dayBtn = document.createElement('div');
      dayBtn.className = 'mf-day';
      dayBtn.textContent = i;

      const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
      const dateObj = new Date(year, month, i);

      // Disable Past Dates
      if (dateObj < today) {
        dayBtn.classList.add('disabled');
      } else {
        dayBtn.addEventListener('click', () => {
          document.querySelectorAll('.mf-day').forEach(d => d.classList.remove('selected'));
          dayBtn.classList.add('selected');
          
          // Update your existing state
          window.selectedDate = dateString;
          datePicker.value = dateString; // Keeps your original logic working
          updateButtonState();
          
          // Update the label above slots
          document.getElementById('mf-selected-day-label').textContent = `Selected: ${dateString}`;
        });
      }

      // Keep selected state if month changes
      if (window.selectedDate === dateString) {
        dayBtn.classList.add('selected');
      }

      calendarDaysContainer.appendChild(dayBtn);
    }
  }

  // Nav Listeners
  prevBtn.addEventListener('click', () => {
    currentViewDate.setMonth(currentViewDate.getMonth() - 1);
    renderCalendar();
  });
  nextBtn.addEventListener('click', () => {
    currentViewDate.setMonth(currentViewDate.getMonth() + 1);
    renderCalendar();
  });

  // Initial Render
  renderCalendar();

function updateButtonState() {
  const isEnabled = window.selectedDate && window.selectedTimeRange;
  
  if (isEnabled) {
    bookBtn.disabled = false;
    bookBtn.classList.remove('disabled');  // Remove gray class
    bookBtn.classList.add('enabled');      // Add blue styling
  } else {
    bookBtn.disabled = true;
    bookBtn.classList.remove('enabled');   // Remove blue class
    bookBtn.classList.add('disabled');     // Add gray styling
  }
}

  // âœ… FETCH CONFIG ON COMPONENT LOAD (not on button click)
  try {
    window.config = await fetchBookingConfig();
    console.log("Pre-loaded config:", window.config);
    
    if (window.config) {
      durationEl.textContent = `ðŸ•’ ${window.config.durationHours} hours, ${window.config.durationMinutes} minutes`;
      generateSlots(window.config, slotsContainer, updateButtonState);
  updateButtonState();
    } else {
      durationEl.textContent = "ðŸ•’ No config found";
    }
  } catch (error) {
    console.error("Config load error:", error);
    durationEl.textContent = "ðŸ•’ Unable to load duration";
  }

  openBtn.addEventListener('click', () => {
    // âœ… Now modal opens instantly - config is already loaded
    document.body.appendChild(modal);
    modal.style.display = 'flex';
    document.body.classList.add('mf-modal-open');
  });

  closeBtn.addEventListener('click', closeModal);
  
  datePicker.addEventListener('change', (e) => {
  window.selectedDate = e.target.value;
  updateButtonState();
});


  function closeModal() {
    modal.style.display = 'none';
    document.body.classList.remove('mf-modal-open');
    if (originalNextSibling) {
      originalParent.insertBefore(modal, originalNextSibling);
    } else {
      originalParent.appendChild(modal);
    }
  }

  bookBtn.addEventListener('click', async () => {
  try {
    const bookingData = {
      selectedDate: window.selectedDate,
      selectedTimeRange: window.selectedTimeRange,
      durationHours: window.config.durationHours,
      durationMinutes: window.config.durationMinutes,
    };

    // âœ… Robust shop detection (same as your working fetchBookingConfig)
    const shop = window.MEETFLOW_SHOP || Shopify?.shop;
    const apiUrl = `https://meetflow-booking-app-roi7.vercel.app/api/book-appointment?shop=${shop}`;
    
    console.log("Booking data:", bookingData);

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(bookingData)
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`HTTP ${response.status}: ${errorText}`);
    }
    
    const result = await response.json();
    console.log("âœ… Booking saved! ID:", result?.appointmentId);
    toastMsg.innerText = `Booked on ${window.selectedDate} at ${window.selectedTimeRange}`;

    // Reset form
    window.selectedDate = null;
    window.selectedTimeRange = null;
    datePicker.value = '';
    document.querySelectorAll('.mf-slot').forEach(slot => slot.classList.remove('selected'));
    updateButtonState();

  } catch (error) {
    console.error('Booking failed:', error);
    toastMsg.innerText = `âŒ ${error.message}`;
  }

  // Show toast (success or error)
  closeModal();
  document.body.appendChild(toaster);
  toaster.style.display = 'flex';

  setTimeout(() => {
    toaster.style.opacity = '0';
    toaster.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      toaster.style.display = 'none';
      toaster.style.opacity = '1';
      if (toasterNextSibling) {
        toasterOriginalParent.insertBefore(toaster, toasterNextSibling);
      } else {
        toasterOriginalParent.appendChild(toaster);
      }
    }, 500);
  }, 5000);
});

});
</script>


{% schema %}
{
  "name": "MeetFlow Booking",
  "target": "body",
  "settings": []
}
{% endschema %}